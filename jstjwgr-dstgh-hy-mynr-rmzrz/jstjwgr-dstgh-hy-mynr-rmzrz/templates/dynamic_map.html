{% extends "shell_unified.html" %} {% block title %}Ù†Ù‚Ø´Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ùˆ Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ{%
endblock %} {% block window_title %}Ù†Ù‚Ø´Ù‡ ÙˆØ§Ù‚Ø¹ÛŒ Ù¾ÙˆÛŒØ§ - Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§{%
endblock %} {% block extra_css %}
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<style>
  .map-container {
    display: flex;
    gap: 12px;
    height: 100%;
  }

  .map-main {
    flex: 2;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .map-controls {
    background: #f0f0f0;
    border: 2px inset #c0c0c0;
    padding: 8px;
    height: 120px;
  }

  .map-display {
    flex: 1;
    border: 2px inset #c0c0c0;
    position: relative;
    min-height: 400px;
  }

  .map-sidebar {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #map {
    width: 100%;
    height: 100%;
    background: #f0f0f0;
  }

  .location-info {
    background: #f0f0f0;
    border: 2px inset #c0c0c0;
    padding: 8px;
    height: 150px;
    overflow-y: auto;
  }

  .ip-details {
    background: #f0f0f0;
    border: 2px inset #c0c0c0;
    padding: 8px;
    height: 200px;
    overflow-y: auto;
  }

  .detected-locations {
    background: #fff0f0;
    border: 2px inset #c0c0c0;
    padding: 8px;
    flex: 1;
    overflow-y: auto;
  }

  .control-row {
    display: flex;
    gap: 8px;
    align-items: center;
    margin: 4px 0;
  }

  .control-row label {
    min-width: 60px;
    font-size: 11px;
    font-weight: bold;
  }

  .control-row input,
  .control-row select {
    flex: 1;
    padding: 2px 4px;
    border: 1px inset #c0c0c0;
    font-size: 10px;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    margin: 2px 0;
    font-size: 10px;
  }

  .info-label {
    font-weight: bold;
  }

  .info-value {
    color: #0000ff;
    font-family: monospace;
  }

  .location-item {
    background: #ffeeee;
    border: 1px solid #cc0000;
    padding: 4px;
    margin: 2px 0;
    font-size: 10px;
    cursor: pointer;
    border-radius: 2px;
  }

  .location-item:hover {
    background: #ffdddd;
  }

  .location-coords {
    color: #666;
    font-family: monospace;
  }

  .location-details {
    margin-top: 2px;
    font-size: 9px;
  }

  .map-legend {
    position: absolute;
    bottom: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid #999;
    padding: 8px;
    font-size: 10px;
    z-index: 1000;
    border-radius: 4px;
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    margin: 2px 0;
  }

  .legend-icon {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 1px solid #000;
  }

  .legend-normal {
    background: #00ff00;
  }
  .legend-suspicious {
    background: #ffaa00;
  }
  .legend-miner {
    background: #ff0000;
  }
  .legend-scanning {
    background: #0088ff;
  }

  .coordinates-display {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 4px 8px;
    font-family: monospace;
    font-size: 10px;
    border-radius: 4px;
    z-index: 1000;
  }

  .custom-popup {
    font-size: 11px;
    line-height: 1.3;
  }

  .popup-title {
    font-weight: bold;
    color: #cc0000;
    margin-bottom: 4px;
  }

  .popup-details {
    margin: 2px 0;
  }

  .popup-action {
    margin-top: 6px;
    text-align: center;
  }

  .popup-btn {
    background: #c0c0c0;
    border: 1px outset #c0c0c0;
    padding: 2px 8px;
    font-size: 9px;
    cursor: pointer;
    margin: 0 2px;
  }

  .popup-btn:hover {
    background: #d0d0d0;
  }
</style>
{% endblock %} {% block content %}
<div class="map-container">
  <!-- Ù†Ù‚Ø´Ù‡ Ø§ØµÙ„ÛŒ -->
  <div class="map-main">
    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ -->
    <div class="map-controls">
      <div class="panel-header">ğŸ—ºï¸ Ú©Ù†ØªØ±Ù„ Ù†Ù‚Ø´Ù‡</div>

      <div class="control-row">
        <label>Ù…Ú©Ø§Ù†:</label>
        <select id="location-select" onchange="centerMapOnLocation()">
          <option value="ilam">Ø§Ø³ØªØ§Ù† Ø§ÛŒÙ„Ø§Ù…</option>
          <option value="tehran">ØªÙ‡Ø±Ø§Ù†</option>
          <option value="isfahan">Ø§ØµÙÙ‡Ø§Ù†</option>
          <option value="custom">Ù…Ø®ØªØµØ§Øª Ø¯Ø³ØªÛŒ</option>
        </select>
        <button class="btn" onclick="refreshMap()">ğŸ”„</button>
      </div>

      <div class="control-row">
        <label>IP Ø¬Ø³ØªØ¬Ùˆ:</label>
        <input
          type="text"
          id="ip-search"
          placeholder="192.168.1.1"
          onkeypress="handleIPSearch(event)"
        />
        <button class="btn" onclick="searchIPLocation()">ğŸ”</button>
      </div>

      <div class="control-row">
        <label>Ù†ÙˆØ¹:</label>
        <select id="display-filter" onchange="filterMapMarkers()">
          <option value="all">Ù‡Ù…Ù‡</option>
          <option value="miners">ÙÙ‚Ø· Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</option>
          <option value="suspicious">Ù…Ø´Ú©ÙˆÚ©</option>
          <option value="normal">Ø¹Ø§Ø¯ÛŒ</option>
        </select>
        <button class="btn" onclick="exportMapData()">ğŸ’¾</button>
      </div>
    </div>

    <!-- Ù†Ù…Ø§ÛŒØ´ Ù†Ù‚Ø´Ù‡ -->
    <div class="map-display">
      <div id="map"></div>

      <!-- Ù…Ø®ØªØµØ§Øª ÙØ¹Ù„ÛŒ -->
      <div class="coordinates-display" id="coordinates-display">
        Ù…Ø®ØªØµØ§Øª: 33.6374, 46.4227 (Ø§ÛŒÙ„Ø§Ù…)
      </div>

      <!-- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù†Ù‚Ø´Ù‡ -->
      <div class="map-legend">
        <div style="font-weight: bold; margin-bottom: 4px">Ø±Ø§Ù‡Ù†Ù…Ø§</div>
        <div class="legend-item">
          <div class="legend-icon legend-normal"></div>
          <span>Ø¹Ø§Ø¯ÛŒ</span>
        </div>
        <div class="legend-item">
          <div class="legend-icon legend-suspicious"></div>
          <span>Ù…Ø´Ú©ÙˆÚ©</span>
        </div>
        <div class="legend-item">
          <div class="legend-icon legend-miner"></div>
          <span>Ù…Ø§ÛŒÙ†Ø±</span>
        </div>
        <div class="legend-item">
          <div class="legend-icon legend-scanning"></div>
          <span>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³Ú©Ù†</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Ø¨Ø®Ø´ Ú©Ù†Ø§Ø±ÛŒ -->
  <div class="map-sidebar">
    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ú©Ø§Ù† -->
    <div class="location-info">
      <div class="panel-header">ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ú©Ø§Ù†</div>
      <div id="location-details">
        <div class="info-row">
          <span class="info-label">Ø§Ø³ØªØ§Ù†:</span>
          <span class="info-value" id="current-province">Ø§ÛŒÙ„Ø§Ù…</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø´Ù‡Ø±:</span>
          <span class="info-value" id="current-city">Ø§ÛŒÙ„Ø§Ù…</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:</span>
          <span class="info-value" id="current-lat">33.6374</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:</span>
          <span class="info-value" id="current-lng">46.4227</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø§Ø±ØªÙØ§Ø¹:</span>
          <span class="info-value" id="current-elevation">1337 Ù…ØªØ±</span>
        </div>
        <div class="info-row">
          <span class="info-label">ISP:</span>
          <span class="info-value" id="current-isp">Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†</span>
        </div>
      </div>
    </div>

    <!-- Ø¬Ø²Ø¦ÛŒØ§Øª IP -->
    <div class="ip-details">
      <div class="panel-header">ğŸŒ Ø¬Ø²Ø¦ÛŒØ§Øª IP</div>
      <div id="ip-info">
        <div class="info-row">
          <span class="info-label">Ø¢Ø¯Ø±Ø³ IP:</span>
          <span class="info-value" id="selected-ip">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ù†ÙˆØ¹:</span>
          <span class="info-value" id="ip-type">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ÙˆØ¶Ø¹ÛŒØª:</span>
          <span class="info-value" id="ip-status">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²:</span>
          <span class="info-value" id="ip-ports">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">ÙØ§ØµÙ„Ù‡:</span>
          <span class="info-value" id="ip-distance">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³Ú©Ù†:</span>
          <span class="info-value" id="ip-last-scan">-</span>
        </div>
        <div style="margin-top: 8px">
          <button
            class="btn"
            onclick="scanSelectedIP()"
            style="width: 100%; font-size: 10px"
          >
            ğŸ” Ø§Ø³Ú©Ù† Ù…Ø¬Ø¯Ø¯
          </button>
        </div>
      </div>
    </div>

    <!-- Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡ -->
    <div class="detected-locations">
      <div class="panel-header">ğŸš¨ Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯Ù‡</div>
      <div id="detected-list">
        <!-- Ù„ÛŒØ³Øª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾ÙˆÛŒØ§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ù†Ù‚Ø´Ù‡
  let map;
  let markersLayer;
  let currentMarkers = [];
  let detectedLocations = [];

  // Ù…Ø®ØªØµØ§Øª Ù…Ø±Ø§Ú©Ø² Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§
  const provinceCoordinates = {
    ilam: { lat: 33.6374, lng: 46.4227, name: "Ø§ÛŒÙ„Ø§Ù…" },
    tehran: { lat: 35.6892, lng: 51.389, name: "ØªÙ‡Ø±Ø§Ù†" },
    isfahan: { lat: 32.6539, lng: 51.666, name: "Ø§ØµÙÙ‡Ø§Ù†" },
    shiraz: { lat: 29.5918, lng: 52.5837, name: "Ø´ÛŒØ±Ø§Ø²" },
    tabriz: { lat: 38.0962, lng: 46.2738, name: "ØªØ¨Ø±ÛŒØ²" },
    mashhad: { lat: 36.2605, lng: 59.6168, name: "Ù…Ø´Ù‡Ø¯" },
  };

  // Ù…Ø®ØªØµØ§Øª Ø¯Ù‚ÛŒÙ‚ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§ÛŒÙ„Ø§Ù…
  const ilamCities = {
    ilam_city: { lat: 33.6374, lng: 46.4227, name: "Ø´Ù‡Ø± Ø§ÛŒÙ„Ø§Ù…" },
    ivan: { lat: 33.7623, lng: 46.285, name: "Ø§ÛŒÙˆØ§Ù†" },
    darreh_shahr: { lat: 33.1445, lng: 47.3792, name: "Ø¯Ø±Ù‡â€ŒØ´Ù‡Ø±" },
    dehloran: { lat: 32.6945, lng: 47.2671, name: "Ø¯Ù‡Ù„Ø±Ø§Ù†" },
    abdanan: { lat: 32.9979, lng: 47.4166, name: "Ø¢Ø¨Ø¯Ø§Ù†Ø§Ù†" },
    mehran: { lat: 33.1222, lng: 46.1644, name: "Ù…Ù‡Ø±Ø§Ù†" },
    malekshahi: { lat: 33.2584, lng: 46.9309, name: "Ù…Ù„Ú©Ø´Ø§Ù‡ÛŒ" },
    sirvan: { lat: 33.8567, lng: 46.0789, name: "Ø³Ø±Ø§Ø¨Ù„Ù‡" },
    chardavol: { lat: 33.2888, lng: 46.7031, name: "Ú†Ø±Ø¯Ø§ÙˆÙ„" },
  };

  // Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù†Ù‚Ø´Ù‡
  document.addEventListener("DOMContentLoaded", function () {
    initializeMap();
    loadInitialData();

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù‡Ø± 5 Ø«Ø§Ù†ÛŒÙ‡
    setInterval(updateLocationData, 5000);
  });

  function initializeMap() {
    // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ù‚Ø´Ù‡ Ø¨Ø§ Ù…Ø±Ú©Ø² Ø§ÛŒÙ„Ø§Ù…
    map = L.map("map").setView([33.6374, 46.4227], 10);

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„Ø§ÛŒÙ‡ Ù†Ù‚Ø´Ù‡ (OpenStreetMap)
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Â© OpenStreetMap contributors",
      maxZoom: 18,
      minZoom: 3,
    }).addTo(map);

    // Ù„Ø§ÛŒÙ‡ Ù…Ø§Ø±Ú©Ø±Ù‡Ø§
    markersLayer = L.layerGroup().addTo(map);

    // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡
    map.on("click", handleMapClick);
    map.on("moveend", updateCoordinatesDisplay);
    map.on("zoomend", updateCoordinatesDisplay);

    // Ù†Ù…Ø§ÛŒØ´ Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø§ÛŒÙ„Ø§Ù…
    addIlamBoundary();

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ÛŒ Ø´Ù‡Ø±Ù‡Ø§ÛŒ Ø§ÛŒÙ„Ø§Ù…
    addIlamCitiesMarkers();

    console.log("ğŸ—ºï¸ Ù†Ù‚Ø´Ù‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯");
  }

  function addIlamBoundary() {
    // Ù…Ø­Ø¯ÙˆØ¯Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø§Ø³ØªØ§Ù† Ø§ÛŒÙ„Ø§Ù…
    const ilamBounds = [
      [33.0, 46.0],
      [34.0, 46.0],
      [34.0, 48.0],
      [33.0, 48.0],
      [33.0, 46.0],
    ];

    const boundary = L.polygon(ilamBounds, {
      color: "#ff0000",
      weight: 2,
      opacity: 0.6,
      fillColor: "#ff0000",
      fillOpacity: 0.1,
    }).addTo(map);

    boundary.bindPopup(
      '<div class="custom-popup"><div class="popup-title">Ø§Ø³ØªØ§Ù† Ø§ÛŒÙ„Ø§Ù…</div><div class="popup-details">Ù…Ø³Ø§Ø­Øª: 20,133 Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ù…Ø±Ø¨Ø¹<br>Ø¬Ù…Ø¹ÛŒØª: Ø­Ø¯ÙˆØ¯ 580,000 Ù†ÙØ±</div></div>',
    );
  }

  function addIlamCitiesMarkers() {
    Object.keys(ilamCities).forEach((cityKey) => {
      const city = ilamCities[cityKey];

      const marker = L.circleMarker([city.lat, city.lng], {
        radius: 6,
        color: "#0066cc",
        weight: 2,
        fillColor: "#0088ff",
        fillOpacity: 0.7,
      }).addTo(markersLayer);

      marker.bindPopup(`
            <div class="custom-popup">
                <div class="popup-title">${city.name}</div>
                <div class="popup-details">
                    Ù…Ø®ØªØµØ§Øª: ${city.lat.toFixed(4)}, ${city.lng.toFixed(4)}<br>
                    ÙˆØ¶Ø¹ÛŒØª: Ù†Ø¸Ø§Ø±Øª ÙØ¹Ø§Ù„
                </div>
                <div class="popup-action">
                    <button class="popup-btn" onclick="scanCityIPs('${cityKey}')">Ø§Ø³Ú©Ù† Ø´Ù‡Ø±</button>
                    <button class="popup-btn" onclick="showCityDetails('${cityKey}')">Ø¬Ø²Ø¦ÛŒØ§Øª</button>
                </div>
            </div>
        `);

      marker.cityKey = cityKey;
      currentMarkers.push(marker);
    });
  }

  function centerMapOnLocation() {
    const location = document.getElementById("location-select").value;

    if (location === "custom") {
      const lat = prompt("Ø¹Ø±Ø¶ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:");
      const lng = prompt("Ø·ÙˆÙ„ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:");

      if (lat && lng) {
        map.setView([parseFloat(lat), parseFloat(lng)], 12);
        updateLocationDetails(parseFloat(lat), parseFloat(lng));
      }
    } else if (provinceCoordinates[location]) {
      const coords = provinceCoordinates[location];
      map.setView([coords.lat, coords.lng], location === "ilam" ? 10 : 8);
      updateLocationDetails(coords.lat, coords.lng, coords.name);
    }
  }

  function handleMapClick(e) {
    const lat = e.latlng.lat;
    const lng = e.latlng.lng;

    updateLocationDetails(lat, lng);

    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ IP Ø¯Ø± Ø§ÛŒÙ† Ù…Ø®ØªØµØ§Øª
    setTimeout(() => {
      const nearbyIPs = findNearbyIPs(lat, lng);
      displayNearbyIPs(nearbyIPs);
    }, 500);
  }

  function updateCoordinatesDisplay() {
    const center = map.getCenter();
    const zoom = map.getZoom();

    document.getElementById("coordinates-display").textContent =
      `Ù…Ø®ØªØµØ§Øª: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)} | Ø²ÙˆÙ…: ${zoom}`;
  }

  function updateLocationDetails(lat, lng, locationName = null) {
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ú©Ø§Ù†
    document.getElementById("current-lat").textContent = lat.toFixed(6);
    document.getElementById("current-lng").textContent = lng.toFixed(6);

    // ØªØ´Ø®ÛŒØµ Ø§Ø³ØªØ§Ù† Ùˆ Ø´Ù‡Ø± Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø®ØªØµØ§Øª
    const locationInfo = getLocationFromCoordinates(lat, lng);

    document.getElementById("current-province").textContent =
      locationInfo.province;
    document.getElementById("current-city").textContent = locationInfo.city;
    document.getElementById("current-elevation").textContent =
      locationInfo.elevation;
    document.getElementById("current-isp").textContent = locationInfo.isp;
  }

  function getLocationFromCoordinates(lat, lng) {
    // ØªØ´Ø®ÛŒØµ Ù…Ú©Ø§Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…Ø®ØªØµØ§Øª

    // Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¯Ø± Ú©Ø¯Ø§Ù… Ø´Ù‡Ø± Ø§ÛŒÙ„Ø§Ù… Ø§Ø³Øª
    for (const [cityKey, cityData] of Object.entries(ilamCities)) {
      const distance = calculateDistance(lat, lng, cityData.lat, cityData.lng);
      if (distance < 20) {
        // Ø¯Ø± Ø´Ø¹Ø§Ø¹ 20 Ú©ÛŒÙ„ÙˆÙ…ØªØ±ÛŒ
        return {
          province: "Ø§ÛŒÙ„Ø§Ù…",
          city: cityData.name,
          elevation: Math.floor(Math.random() * 500) + 1000 + " Ù…ØªØ±",
          isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
        };
      }
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø³ØªØ§Ù†â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
    if (lat >= 33.0 && lat <= 34.0 && lng >= 46.0 && lng <= 48.0) {
      return {
        province: "Ø§ÛŒÙ„Ø§Ù…",
        city: "Ù†Ø§Ù…Ø´Ø®Øµ",
        elevation: Math.floor(Math.random() * 500) + 1000 + " Ù…ØªØ±",
        isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
      };
    }

    return {
      province: "Ù†Ø§Ù…Ø´Ø®Øµ",
      city: "Ù†Ø§Ù…Ø´Ø®Øµ",
      elevation: "Ù†Ø§Ù…Ø´Ø®Øµ",
      isp: "Ù†Ø§Ù…Ø´Ø®Øµ",
    };
  }

  function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Ø´Ø¹Ø§Ø¹ Ø²Ù…ÛŒÙ† Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÙ…ØªØ±
    const dLat = ((lat2 - lat1) * Math.PI) / 180;
    const dLng = ((lng2 - lng1) * Math.PI) / 180;
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos((lat1 * Math.PI) / 180) *
        Math.cos((lat2 * Math.PI) / 180) *
        Math.sin(dLng / 2) *
        Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function searchIPLocation() {
    const ip = document.getElementById("ip-search").value.trim();

    if (!isValidIP(ip)) {
      alert("Ø¢Ø¯Ø±Ø³ IP Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª");
      return;
    }

    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ú©Ø§Ù† IP
    const location = getIPLocation(ip);

    if (location) {
      // Ø­Ø±Ú©Øª Ù†Ù‚Ø´Ù‡ Ø¨Ù‡ Ù…Ú©Ø§Ù† IP
      map.setView([location.lat, location.lng], 15);

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø§Ø±Ú©Ø± Ø¨Ø±Ø§ÛŒ IP
      addIPMarker(ip, location);

      // Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª IP
      displayIPDetails(ip, location);

      console.log(
        `ğŸ“ IP ${ip} Ø¯Ø± Ù…Ø®ØªØµØ§Øª ${location.lat}, ${location.lng} ÛŒØ§ÙØª Ø´Ø¯`,
      );
    } else {
      alert("Ù…Ú©Ø§Ù† IP ÛŒØ§ÙØª Ù†Ø´Ø¯");
    }
  }

  function getIPLocation(ip) {
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ IP
    // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² API Ù…Ú©Ø§Ù†â€ŒÛŒØ§Ø¨ÛŒ ÛŒØ§ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ GeoIP Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

    const ipRanges = {
      213.207: {
        lat: 33.6374,
        lng: 46.4227,
        city: "Ø§ÛŒÙ„Ø§Ù…",
        isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
      },
      185.74: {
        lat: 33.2888,
        lng: 46.7031,
        city: "Ú†Ø±Ø¯Ø§ÙˆÙ„",
        isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
      },
      192.168: { lat: 33.6374, lng: 46.4227, city: "Ø´Ø¨Ú©Ù‡ Ù…Ø­Ù„ÛŒ", isp: "Ù…Ø­Ù„ÛŒ" },
      "5.200": {
        lat: 35.6892,
        lng: 51.389,
        city: "ØªÙ‡Ø±Ø§Ù†",
        isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
      },
    };

    for (const [range, location] of Object.entries(ipRanges)) {
      if (ip.startsWith(range)) {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØºÛŒÛŒØ±Ø§Øª ØªØµØ§Ø¯ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ù‚ÛŒÙ‚â€ŒØªØ±
        return {
          lat: location.lat + (Math.random() - 0.5) * 0.01,
          lng: location.lng + (Math.random() - 0.5) * 0.01,
          city: location.city,
          isp: location.isp,
          type: Math.random() < 0.1 ? "miner" : "normal",
        };
      }
    }

    return null;
  }

  function addIPMarker(ip, location) {
    // ØªØ¹ÛŒÛŒÙ† Ø±Ù†Ú¯ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    const colors = {
      normal: "#00ff00",
      suspicious: "#ffaa00",
      miner: "#ff0000",
      scanning: "#0088ff",
    };

    const color = colors[location.type] || colors.normal;

    const marker = L.circleMarker([location.lat, location.lng], {
      radius: 8,
      color: "#000",
      weight: 1,
      fillColor: color,
      fillOpacity: 0.8,
    }).addTo(markersLayer);

    // Ù…Ø­ØªÙˆØ§ÛŒ popup
    const popupContent = `
        <div class="custom-popup">
            <div class="popup-title">IP: ${ip}</div>
            <div class="popup-details">
                Ù…Ú©Ø§Ù†: ${location.city}<br>
                ISP: ${location.isp}<br>
                Ù†ÙˆØ¹: ${location.type}<br>
                Ù…Ø®ØªØµØ§Øª: ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}
            </div>
            <div class="popup-action">
                <button class="popup-btn" onclick="scanIP('${ip}')">Ø§Ø³Ú©Ù†</button>
                <button class="popup-btn" onclick="traceIP('${ip}')">Ø±Ø¯ÛŒØ§Ø¨ÛŒ</button>
                <button class="popup-btn" onclick="blockIP('${ip}')">Ù…Ø³Ø¯ÙˆØ¯</button>
            </div>
        </div>
    `;

    marker.bindPopup(popupContent);
    marker.ipAddress = ip;
    marker.locationType = location.type;

    currentMarkers.push(marker);

    // Ø§Ú¯Ø± Ù…Ø§ÛŒÙ†Ø± Ø§Ø³ØªØŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ Ù„ÛŒØ³Øª
    if (location.type === "miner") {
      addDetectedLocation(ip, location);
    }
  }

  function addDetectedLocation(ip, location) {
    const detectionTime = new Date().toLocaleTimeString("fa-IR");

    const detection = {
      ip: ip,
      location: location,
      time: detectionTime,
      id: Date.now(),
    };

    detectedLocations.push(detection);

    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¨Ù‡ UI
    const detectedList = document.getElementById("detected-list");
    const item = document.createElement("div");
    item.className = "location-item";
    item.onclick = () => selectDetectedLocation(detection.id);

    item.innerHTML = `
        <div style="font-weight: bold; color: #cc0000;">${ip}</div>
        <div class="location-coords">${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}</div>
        <div class="location-details">
            Ø´Ù‡Ø±: ${location.city} | ISP: ${location.isp}<br>
            Ø²Ù…Ø§Ù†: ${detectionTime}
        </div>
    `;

    detectedList.appendChild(item);

    // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ù¾Ø§ÛŒÛŒÙ†
    detectedList.scrollTop = detectedList.scrollHeight;

    console.log(`ğŸš¨ Ù…Ø§ÛŒÙ†Ø± Ø¬Ø¯ÛŒØ¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯: ${ip} Ø¯Ø± ${location.city}`);
  }

  function selectDetectedLocation(id) {
    const detection = detectedLocations.find((d) => d.id === id);
    if (detection) {
      map.setView([detection.location.lat, detection.location.lng], 16);
      displayIPDetails(detection.ip, detection.location);
    }
  }

  function displayIPDetails(ip, location) {
    document.getElementById("selected-ip").textContent = ip;
    document.getElementById("ip-type").textContent = location.type;
    document.getElementById("ip-status").textContent =
      location.type === "miner" ? "Ù…Ø§ÛŒÙ†Ø± ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡" : "Ø¹Ø§Ø¯ÛŒ";

    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²
    const openPorts =
      location.type === "miner"
        ? ["3333", "4444", "22", "80"]
        : ["22", "80", "443"];
    document.getElementById("ip-ports").textContent = openPorts.join(", ");

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ ÙØ§ØµÙ„Ù‡ Ø§Ø² Ù…Ø±Ú©Ø² Ù†Ù‚Ø´Ù‡
    const center = map.getCenter();
    const distance = calculateDistance(
      center.lat,
      center.lng,
      location.lat,
      location.lng,
    );
    document.getElementById("ip-distance").textContent =
      distance.toFixed(2) + " Ú©ÛŒÙ„ÙˆÙ…ØªØ±";

    document.getElementById("ip-last-scan").textContent =
      new Date().toLocaleTimeString("fa-IR");
  }

  function findNearbyIPs(lat, lng) {
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ IP Ù‡Ø§ÛŒ Ù†Ø²Ø¯ÛŒÚ©
    const nearbyIPs = [];
    const numIPs = Math.floor(Math.random() * 5) + 1;

    for (let i = 0; i < numIPs; i++) {
      const randomIP = generateRandomIP();
      const randomOffset = (Math.random() - 0.5) * 0.005;

      nearbyIPs.push({
        ip: randomIP,
        lat: lat + randomOffset,
        lng: lng + randomOffset,
        type: Math.random() < 0.2 ? "miner" : "normal",
      });
    }

    return nearbyIPs;
  }

  function displayNearbyIPs(ips) {
    ips.forEach((ipData) => {
      const location = {
        lat: ipData.lat,
        lng: ipData.lng,
        city: "Ù†Ø²Ø¯ÛŒÚ© Ú©Ù„ÛŒÚ©",
        isp: "Ù†Ø§Ù…Ø´Ø®Øµ",
        type: ipData.type,
      };

      addIPMarker(ipData.ip, location);
    });
  }

  function generateRandomIP() {
    // ØªÙˆÙ„ÛŒØ¯ IP ØªØµØ§Ø¯ÙÛŒ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†ÛŒ
    const ranges = ["213.207", "185.74", "192.168", "5.200"];
    const range = ranges[Math.floor(Math.random() * ranges.length)];

    return `${range}.${Math.floor(Math.random() * 256)}.${Math.floor(Math.random() * 256)}`;
  }

  function isValidIP(ip) {
    const regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!regex.test(ip)) return false;

    const parts = ip.split(".");
    return parts.every((part) => {
      const num = parseInt(part);
      return num >= 0 && num <= 255;
    });
  }

  function filterMapMarkers() {
    const filter = document.getElementById("display-filter").value;

    currentMarkers.forEach((marker) => {
      if (filter === "all") {
        marker.addTo(markersLayer);
      } else if (filter === "miners" && marker.locationType === "miner") {
        marker.addTo(markersLayer);
      } else if (
        filter === "suspicious" &&
        marker.locationType === "suspicious"
      ) {
        marker.addTo(markersLayer);
      } else if (filter === "normal" && marker.locationType === "normal") {
        marker.addTo(markersLayer);
      } else {
        markersLayer.removeLayer(marker);
      }
    });
  }

  function refreshMap() {
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    loadInitialData();
    console.log("ğŸ”„ Ù†Ù‚Ø´Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯");
  }

  function loadInitialData() {
    // Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
    setTimeout(() => {
      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ Ù…Ø§ÛŒÙ†Ø± Ù†Ù…ÙˆÙ†Ù‡
      addSampleMiners();
    }, 1000);
  }

  function addSampleMiners() {
    const sampleMiners = [
      { ip: "213.207.128.45", lat: 33.6274, lng: 46.4327, city: "Ø§ÛŒÙ„Ø§Ù…" },
      { ip: "185.74.0.67", lat: 33.2788, lng: 46.7131, city: "Ú†Ø±Ø¯Ø§ÙˆÙ„" },
      { ip: "192.168.1.89", lat: 33.7523, lng: 46.295, city: "Ø§ÛŒÙˆØ§Ù†" },
    ];

    sampleMiners.forEach((miner) => {
      const location = {
        lat: miner.lat,
        lng: miner.lng,
        city: miner.city,
        isp: "Ù…Ø®Ø§Ø¨Ø±Ø§Øª Ø§ÛŒØ±Ø§Ù†",
        type: "miner",
      };

      addIPMarker(miner.ip, location);
    });
  }

  function updateLocationData() {
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø§Ù†
    // Ø¯Ø± ÙˆØ§Ù‚Ø¹ÛŒØª Ø§Ø² API Ø²Ù†Ø¯Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
  }

  function handleIPSearch(event) {
    if (event.key === "Enter") {
      searchIPLocation();
    }
  }

  // ØªÙˆØ§Ø¨Ø¹ Ø¹Ù…Ù„ÛŒØ§ØªÛŒ
  function scanIP(ip) {
    console.log(`ğŸ” Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù† IP: ${ip}`);
    alert(`Ø§Ø³Ú©Ù† IP ${ip} Ø´Ø±ÙˆØ¹ Ø´Ø¯`);
  }

  function traceIP(ip) {
    console.log(`ğŸ” Ø±Ø¯ÛŒØ§Ø¨ÛŒ IP: ${ip}`);
    alert(`Ø±Ø¯ÛŒØ§Ø¨ÛŒ IP ${ip} Ø´Ø±ÙˆØ¹ Ø´Ø¯`);
  }

  function blockIP(ip) {
    console.log(`ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† IP: ${ip}`);
    if (confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ IP ${ip} Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†ÛŒØ¯ØŸ`)) {
      alert(`IP ${ip} Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯`);
    }
  }

  function scanCityIPs(cityKey) {
    const city = ilamCities[cityKey];
    console.log(`ğŸ™ï¸ Ø§Ø³Ú©Ù† Ø´Ù‡Ø± ${city.name}`);
    alert(`Ø§Ø³Ú©Ù† IP Ù‡Ø§ÛŒ Ø´Ù‡Ø± ${city.name} Ø´Ø±ÙˆØ¹ Ø´Ø¯`);
  }

  function showCityDetails(cityKey) {
    const city = ilamCities[cityKey];
    alert(`Ø¬Ø²Ø¦ÛŒØ§Øª Ø´Ù‡Ø± ${city.name}\nÙ…Ø®ØªØµØ§Øª: ${city.lat}, ${city.lng}`);
  }

  function scanSelectedIP() {
    const ip = document.getElementById("selected-ip").textContent;
    if (ip && ip !== "-") {
      scanIP(ip);
    }
  }

  function exportMapData() {
    const data = {
      detected_locations: detectedLocations,
      map_center: map.getCenter(),
      zoom_level: map.getZoom(),
      export_time: new Date().toISOString(),
    };

    const content = JSON.stringify(data, null, 2);
    const blob = new Blob([content], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `map-data-${Date.now()}.json`;
    a.click();

    URL.revokeObjectURL(url);
    console.log("ğŸ’¾ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ù‚Ø´Ù‡ ØµØ§Ø¯Ø± Ø´Ø¯");
  }
</script>
{% endblock %} {% block sidebar %}
<div class="panel">
  <div class="panel-header">ğŸ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø³Ø±ÛŒØ¹</div>
  <button
    class="btn"
    style="width: 100%; margin: 2px 0"
    onclick="centerMapOnLocation(); document.getElementById('location-select').value='ilam';"
  >
    ğŸ›ï¸ Ø§ÛŒÙ„Ø§Ù…
  </button>
  <button
    class="btn"
    style="width: 100%; margin: 2px 0"
    onclick="addSampleMiners()"
  >
    â›ï¸ Ù†Ù…Ø§ÛŒØ´ Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
  </button>
  <button
    class="btn"
    style="width: 100%; margin: 2px 0"
    onclick="clearAllMarkers()"
  >
    ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù†Ù‚Ø´Ù‡
  </button>
</div>

<div class="panel">
  <div class="panel-header">ğŸ“Š Ø¢Ù…Ø§Ø± Ù†Ù‚Ø´Ù‡</div>
  <div style="font-size: 10px; line-height: 1.4">
    <div>Ù…Ø§Ø±Ú©Ø±Ù‡Ø§: <span id="total-markers">0</span></div>
    <div>Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§: <span id="total-miners">0</span></div>
    <div>Ù…Ø´Ú©ÙˆÚ©: <span id="total-suspicious">0</span></div>
    <div>Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="last-update">-</span></div>
  </div>
</div>

<script>
  function clearAllMarkers() {
    markersLayer.clearLayers();
    currentMarkers = [];
    detectedLocations = [];
    document.getElementById("detected-list").innerHTML = "";
    console.log("ğŸ—‘ï¸ Ù‡Ù…Ù‡ Ù…Ø§Ø±Ú©Ø±Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù†Ø¯");
  }

  // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¢Ù…Ø§Ø± Ù†Ù‚Ø´Ù‡
  setInterval(() => {
    document.getElementById("total-markers").textContent =
      currentMarkers.length;
    document.getElementById("total-miners").textContent = currentMarkers.filter(
      (m) => m.locationType === "miner",
    ).length;
    document.getElementById("total-suspicious").textContent =
      currentMarkers.filter((m) => m.locationType === "suspicious").length;
    document.getElementById("last-update").textContent =
      new Date().toLocaleTimeString("fa-IR");
  }, 5000);
</script>
{% endblock %}
