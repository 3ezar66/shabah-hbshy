<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}سیستم شناسایی ماینرهای رمزارز{% endblock %}</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Vazir:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Vazir", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .navbar {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(10px);
      }
      .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        background: rgba(255, 255, 255, 0.95);
      }
      .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        border: none;
        border-radius: 25px;
        padding: 10px 30px;
        font-weight: 500;
      }
      .btn-primary:hover {
        background: linear-gradient(45deg, #764ba2, #667eea);
        transform: translateY(-2px);
      }
      .sidebar {
        background: rgba(255, 255, 255, 0.95);
        min-height: 100vh;
        backdrop-filter: blur(10px);
      }
      .sidebar .nav-link {
        color: #333;
        font-weight: 500;
        margin: 5px 0;
        border-radius: 10px;
        transition: all 0.3s ease;
      }
      .sidebar .nav-link:hover {
        background: rgba(102, 126, 234, 0.1);
        color: #667eea;
      }
      .sidebar .nav-link.active {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
      }
      .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 20px;
        margin: 10px 0;
      }
      .threat-critical {
        border-right: 5px solid #dc3545;
      }
      .threat-high {
        border-right: 5px solid #fd7e14;
      }
      .threat-medium {
        border-right: 5px solid #ffc107;
      }
      .threat-low {
        border-right: 5px solid #28a745;
      }
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .chart-container {
        position: relative;
        height: 300px;
        margin: 20px 0;
      }
      .alert {
        border-radius: 10px;
        border: none;
      }
      .table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
      }
      .page-header {
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
      }

      /* Live DateTime Styles */
      .live-datetime {
        text-align: center;
        font-weight: 500;
      }
      .persian-date {
        font-size: 14px;
        color: #667eea;
        font-weight: 600;
      }
      .persian-time {
        font-size: 18px;
        color: #333;
        font-weight: 700;
        font-family: "Courier New", monospace;
      }

      /* Status Indicators */
      .status-indicators {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
      .status-item {
        font-size: 12px;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        animation: pulse-dot 2s infinite;
      }
      .status-item.online .status-dot {
        color: #28a745;
      }
      .status-item.offline .status-dot {
        color: #dc3545;
      }
      .status-icon {
        color: #17a2b8;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Navigation Buttons */
      .nav-buttons .btn {
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }
      .nav-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .navbar-nav.mx-auto {
          display: none;
        }
        .nav-buttons .btn {
          width: 30px;
          height: 30px;
          font-size: 12px;
        }
      }

      /* Developer Info Styles */
      .developer-info {
        position: fixed;
        bottom: 10px;
        left: 10px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 11px;
        z-index: 1000;
        opacity: 0.7;
        transition: opacity 0.3s ease;
      }
      .developer-info:hover {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('dashboard') }}">
          <i class="fas fa-shield-alt"></i> سیستم شناسایی ماینر
        </a>

        <!-- Live Date/Time and Status -->
        <div class="navbar-nav mx-auto">
          <div class="d-flex align-items-center">
            <div class="me-4">
              <div class="live-datetime">
                <div class="persian-date" id="persianDate"></div>
                <div class="persian-time" id="persianTime"></div>
              </div>
            </div>
            <div class="status-indicators">
              <span class="status-item online" id="systemStatus">
                <i class="fas fa-circle status-dot"></i> آنلاین
              </span>
              <span class="status-item" id="networkStatus">
                <i class="fas fa-wifi status-icon"></i> متصل
              </span>
            </div>
          </div>
        </div>

        <!-- Navigation Keys -->
        <div class="navbar-nav ms-auto">
          <div class="nav-buttons me-3">
            <button
              class="btn btn-outline-primary btn-sm me-1"
              onclick="history.back()"
              title="برگشت"
            >
              <i class="fas fa-arrow-right"></i>
            </button>
            <button
              class="btn btn-outline-primary btn-sm me-1"
              onclick="window.location.href='{{ url_for('dashboard') }}'"
              title="خانه"
            >
              <i class="fas fa-home"></i>
            </button>
            <button
              class="btn btn-outline-primary btn-sm me-1"
              onclick="location.reload()"
              title="تازه‌سازی"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
            <button
              class="btn btn-outline-danger btn-sm"
              onclick="window.location.href='{{ url_for('logout') }}'"
              title="خروج"
            >
              <i class="fas fa-sign-out-alt"></i>
            </button>
          </div>
          <span class="navbar-text">
            <i class="fas fa-user"></i> {{ session.username or 'عرفان رجبی' }}
          </span>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-md-2 sidebar p-3">
          <nav class="nav flex-column">
            <a
              class="nav-link {{ 'active' if request.endpoint == 'index' }}"
              href="{{ url_for('index') }}"
            >
              <i class="fas fa-tachometer-alt"></i> داشبورد
            </a>
            <a
              class="nav-link {{ 'active' if request.endpoint == 'scan' }}"
              href="{{ url_for('scan') }}"
            >
              <i class="fas fa-search"></i> اسکن جدید
            </a>
            <a
              class="nav-link {{ 'active' if request.endpoint == 'miners' }}"
              href="{{ url_for('miners') }}"
            >
              <i class="fas fa-microchip"></i> ماینرهای یافت شده
            </a>
            <a
              class="nav-link {{ 'active' if request.endpoint == 'reports' }}"
              href="{{ url_for('reports') }}"
            >
              <i class="fas fa-chart-bar"></i> گزارشات
            </a>
            <a class="nav-link" href="#" id="liveMonitor">
              <i class="fas fa-eye"></i> نظارت زنده
            </a>
          </nav>
        </div>
        <div class="col-md-10 p-3">
          {% with messages = get_flashed_messages(with_categories=true) %} {% if
          messages %} {% for category, message in messages %}
          <div
            class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show"
            role="alert"
          >
            {{ message }}
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="alert"
            ></button>
          </div>
          {% endfor %} {% endif %} {% endwith %} {% block content %}{% endblock
          %}
        </div>
      </div>
    </div>

    <!-- Developer Information -->
    <div class="developer-info">
      <i class="fas fa-code"></i> طراحی و توسعه: عرفان رجبی (Erfan Rajabi)
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="{{ url_for('static', filename='js/persian-calendar.js') }}"></script>
    <script>
      let liveMonitoringActive = false;

      // Persian Calendar and Time Functions
      function getPersianDate() {
        const now = new Date();
        const persianDays = [
          "یکشنبه",
          "دوشنبه",
          "سه‌شنبه",
          "چهارشنبه",
          "پنج‌شنبه",
          "جمعه",
          "شنبه",
        ];
        const persianMonths = [
          "فروردین",
          "اردیبهشت",
          "خرداد",
          "تیر",
          "مرداد",
          "شهریور",
          "مهر",
          "آبان",
          "آذر",
          "دی",
          "بهمن",
          "اسفند",
        ];

        const dayOfWeek = persianDays[now.getDay()];

        // Simple Persian date conversion (approximate)
        const persianYear = now.getFullYear() - 621;
        const persianMonth = persianMonths[now.getMonth() % 12];
        const persianDay = now.getDate();

        return `${dayOfWeek}، ${persianDay} ${persianMonth} ${persianYear}`;
      }

      function updateDateTime() {
        const now = new Date();
        const persianDate = getPersianDate();
        const time = now.toLocaleTimeString("fa-IR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });

        const dateElement = document.getElementById("persianDate");
        const timeElement = document.getElementById("persianTime");

        if (dateElement) dateElement.textContent = persianDate;
        if (timeElement) timeElement.textContent = time;
      }

      // Network Status Monitoring
      function updateNetworkStatus() {
        const systemStatus = document.getElementById("systemStatus");
        const networkStatus = document.getElementById("networkStatus");

        // Check if online
        if (navigator.onLine) {
          if (systemStatus) {
            systemStatus.className = "status-item online";
            systemStatus.innerHTML =
              '<i class="fas fa-circle status-dot"></i> آنلاین';
          }
          if (networkStatus) {
            networkStatus.innerHTML =
              '<i class="fas fa-wifi status-icon"></i> متصل';
          }
        } else {
          if (systemStatus) {
            systemStatus.className = "status-item offline";
            systemStatus.innerHTML =
              '<i class="fas fa-circle status-dot"></i> آفلاین';
          }
          if (networkStatus) {
            networkStatus.innerHTML =
              '<i class="fas fa-wifi-slash status-icon"></i> قطع';
          }
        }
      }

      // Initialize live updates
      function initializeLiveUpdates() {
        updateDateTime();
        updateNetworkStatus();

        // Update every second
        setInterval(updateDateTime, 1000);
        setInterval(updateNetworkStatus, 5000);
      }

      // Listen for online/offline events
      window.addEventListener("online", updateNetworkStatus);
      window.addEventListener("offline", updateNetworkStatus);

      // Start updates when page loads
      document.addEventListener("DOMContentLoaded", initializeLiveUpdates);

      // نظارت زنده
      document
        .getElementById("liveMonitor")
        ?.addEventListener("click", function (e) {
          e.preventDefault();
          startLiveMonitoring();
        });

      function startLiveMonitoring() {
        if (liveMonitoringActive) return;
        liveMonitoringActive = true;

        const interval = setInterval(function () {
          if (!liveMonitoringActive) {
            clearInterval(interval);
            return;
          }

          fetch("/api/live_monitor")
            .then((response) => {
              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`,
                );
              }
              return response.json();
            })
            .then((data) => {
              if (
                data.suspicious_processes &&
                data.suspicious_processes.length > 0
              ) {
                showAlert("فرآیند مشکوک شناسایی شد!", "warning");
              }
              if (
                data.network_connections &&
                data.network_connections.length > 0
              ) {
                showAlert("اتصال شبکه مشکوک ش��اسایی شد!", "danger");
              }
            })
            .catch((error) => {
              console.error("Live monitoring error:", error);
              // Don't clear interval on temporary errors
            });
        }, 5000);
      }

      function showAlert(message, type) {
        const alertDiv = document.createElement("div");
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
        document.body.prepend(alertDiv);

        setTimeout(() => {
          alertDiv.remove();
        }, 5000);
      }

      // بروزرسانی معیارهای سیستم
      function updateSystemMetrics() {
        fetch("/api/system_metrics")
          .then((response) => {
            if (!response.ok) {
              throw new Error(
                `HTTP ${response.status}: ${response.statusText}`,
              );
            }
            return response.json();
          })
          .then((data) => {
            const cpuElement = document.getElementById("cpu-usage");
            const memoryElement = document.getElementById("memory-usage");
            if (cpuElement && data.cpu_usage !== undefined) {
              cpuElement.textContent = data.cpu_usage.toFixed(1) + "%";
            }
            if (memoryElement && data.memory_usage !== undefined) {
              memoryElement.textContent = data.memory_usage.toFixed(1) + "%";
            }
          })
          .catch((error) => console.error("System metrics error:", error));
      }

      // بروزرسانی هر 10 ثانیه
      setInterval(updateSystemMetrics, 10000);
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
